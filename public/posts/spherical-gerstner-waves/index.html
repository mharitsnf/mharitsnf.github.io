<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Spherical Gerstner Wave: Vertex Shader :: Harits Nur Fauzan</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Ocean waves simulation on spherical surfaces in Godot Engine 4" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="//localhost:1313/posts/spherical-gerstner-waves/" />





  
  <link rel="stylesheet" href="//localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="//localhost:1313/terminal.css">




<link rel="shortcut icon" href="//localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Spherical Gerstner Wave: Vertex Shader">
<meta property="og:description" content="Ocean waves simulation on spherical surfaces in Godot Engine 4" />
<meta property="og:url" content="//localhost:1313/posts/spherical-gerstner-waves/" />
<meta property="og:site_name" content="Harits Nur Fauzan" />

  <meta property="og:image" content="//localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-09-03 18:09:51 &#43;0200 CEST" />












</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Harits Nur Fauzan
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/spherical-gerstner-waves/">Spherical Gerstner Wave: Vertex Shader</a>
  </h1>
  <div class="post-meta"><time class="post-date">2025-09-03</time><span class="post-reading-time">17 min read (3535 words)</span></div>

  
    <span class="post-tags">
      
      #<a href="//localhost:1313/tags/godot/">godot</a>&nbsp;
      
      #<a href="//localhost:1313/tags/computer-graphics/">computer-graphics</a>&nbsp;
      
    </span>
  
  
  <img src="/posts/spherical-gerstner-waves/cover.png"
    class="post-cover"
    alt="Spherical Gerstner Wave: Vertex Shader"
    title="Cover Image" />


  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-this">What is This?</a></li>
    <li><a href="#setting-up-the-scene">Setting Up the Scene</a></li>
    <li><a href="#projection-calculation">Projection Calculation</a></li>
    <li><a href="#gerstner-wave-calculation">Gerstner Wave Calculation</a></li>
    <li><a href="#wave-data-and-direction-using-texture">Wave Data and Direction using Texture</a>
      <ul>
        <li><a href="#texture-generator-setup">Texture Generator Setup</a></li>
        <li><a href="#shader-updates">Shader Updates</a></li>
      </ul>
    </li>
    <li><a href="#uh-my-ocean-is-white">Uh&hellip; My Ocean is White?</a></li>
    <li><a href="#yay-conclusion-whats-next">Yay! Conclusion! What&rsquo;s Next?</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <h2 id="what-is-this">What is This?<a href="#what-is-this" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>I spent a few days trying to figure out how to properly simulate ocean waves for spherical levels in video games. I managed to do it for flat surfaces thanks to <!-- raw HTML omitted -->Catlike Coding&rsquo;s awesome walkthrough of the Gerstner Wave <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><!-- raw HTML omitted -->, but trying to project a flat plane onto a sphere and making the waves work like before is a different problem, one that I could not solve on my own.</p>
<p>So I thought there has to be someone smarter than me who had solved this issue before, knowing that we&rsquo;ve had games that features planets with oceans, right? (Looking at you, Giant&rsquo;s Deep in Outer Wilds.) And well, I stumbled upon a paper called <!-- raw HTML omitted --><em>Real-Time Rendering of Procedurally Generated Planets</em> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup><!-- raw HTML omitted -->, written by Florian Michelic and Michael Kenzel which explains how to deal with this exact problem! Usually I&rsquo;d steer clear from scientific papers because they can be rather difficult to comprehend, but honestly it&rsquo;s hard to do that when you&rsquo;re working on computer graphics stuff. So, driven by my curiosity, I managed to implement their method in my game engine of choice, namely Godot Engine 4, and actually had a pretty good time reading the paper as I think it was really well written! I also received great help from <!-- raw HTML omitted -->kulesz&rsquo;s PlanetaryWater repository <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup><!-- raw HTML omitted -->, which is also an implementation of the method, but in Unity.</p>
<p>I&rsquo;m quite satisfied with the result (you can see in the video below); the method they came up with produces waves that are distortion-free, meaning it will look good regardless of where you are, whether you&rsquo;re looking from a certain point on the planet or from the space, and it works wonders with large amount of waves (more detailed) or small amount of waves (more simple, which is what I&rsquo;m after.)
<video controls preload="auto" width="100%"  playsinline class="html-video">
    <source src="/posts/spherical-gerstner-waves/overview.mp4" type="video/mp4">
  <span>Your browser doesn't support embedded videos, but don't worry, you can <a href="/posts/spherical-gerstner-waves/overview.mp4">download it</a> and watch it with your favorite video player!</span>
</video>
I used 20 waves in the video, in which you can play around with the plane size and the radius. You can also tweak the amplitude, frequency, and time scale of the waves. It is also possible to change the orientation of the plane using the basis uniform.</p>
<p>The repository of this project can be found <a href="https://github.com/mharitsnf/godot-spherical-gerstner-waves">here</a>.</p>
<hr>
<h2 id="setting-up-the-scene">Setting Up the Scene<a href="#setting-up-the-scene" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Let&rsquo;s get started! As I mentioned, I&rsquo;m using Godot Engine 4, but you should be able to replicate this in any other engine. At the end of this article, you&rsquo;ll have a spherical gerstner wave implementation in the vertex shader.</p>
<p>Note that I&rsquo;m not doing the frament shader for now mainly because I&rsquo;m lazy, and also I haven&rsquo;t got a good art direction for my ocean. I&rsquo;ll come back to that in a future article.</p>
<p>Firstly, let&rsquo;s create a <code>MeshInstance3D</code> node that would be our main visual, which will hold our shader material as well. We want a PlaneMesh for the mesh, and set the size to 2 on both the width and height. This way we can ensure that the bottom left corner of the plane will fall on the coordinates (-1, -1), while the top right corner of the plane will fall on the coordinate (1, 1). This is necessary for the grid projection calculation that we will be doing in the next section.</p>
<p><img src="/posts/spherical-gerstner-waves/initial-plane.png" alt="Test"></p>
<p>We also want to set the subdivide width and depth to a number we like. I&rsquo;m setting both the width and depth to 128, as I think it&rsquo;s a good spot for the fidelity I&rsquo;m after. You can crank it up to 256 or 512 to make it even more hi-fi, or lower it to 64 to make it more lo-fi. Just remember, the higher the number, the slower it becomes as the number of vertices the shader will need to operate will also increase.</p>
<p>Now, let&rsquo;s create a spatial shader file (I call mine <code>ocean.shader</code>), and save it somewhere in the project (I put mine in the root of the project). After that, let&rsquo;s also create a material based on that shader called <code>m_ocean.tres</code>, and then assign it to the plane:</p>
<p><img src="/posts/spherical-gerstner-waves/material-setup.png" alt="Test"></p>
<hr>
<h2 id="projection-calculation">Projection Calculation<a href="#projection-calculation" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Let&rsquo;s start with the basic projection method. The basic projection method (that is not distortion-free) involves raising the plane (increasing the Y position of the plane), normalizing the vertices so that we would project the vertices onto a unit sphere, and then multiplying that value with our desired planet radius. Let&rsquo;s add new uniform variables in the shader called <code>y_offset</code> and <code>radius</code>, and then do the calculation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">y_offset</span> <span class="o">=</span> <span class="mf">100.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">radius</span> <span class="o">=</span> <span class="mf">1000.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">vec3</span> <span class="n">init_vertex</span> <span class="o">=</span> <span class="n">VERTEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_vertex</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">VERTEX</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">)</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is how it looks like with <code>y_offset</code> equals to <code>1.5</code> and <code>radius</code> equals to <code>100.0</code>:</p>
<p><img src="/posts/spherical-gerstner-waves/1-1-basic-projection.png" alt="Basic projection"></p>
<p>It looks okay, but you can see the distortion problem when you set the <code>y_offset</code> value to something close to <code>0.0</code> (which transforms the plane into a hemisphere), and change the view mode to wireframe mode:</p>
<p><img src="/posts/spherical-gerstner-waves/1-2-distorted.png" alt="Distorted projection"></p>
<p>The vertices are concentrated on the bottom part, leaving the top part with very few vertices for us to operate on. On top of that, if you decrease the <code>y_offset</code> value to lower than <code>0.0</code>, the plane will wrap its back onto the other way of the planet.</p>
<p>The projection method proposed in the paper involves adding an extra calculation on the <code>init_vertex.y</code> so that it transforms the plane into something resembling a dome using the <code>pow(x,y)</code> function, before finally adding the <code>y_offset</code> value onto <code>init_vertex.y</code> again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">y_exponent</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">vec3</span> <span class="n">init_vertex</span> <span class="o">=</span> <span class="n">VERTEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_vertex</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">y_exponent</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">.</span><span class="n">z</span><span class="p">),</span> <span class="n">y_exponent</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">vec3</span> <span class="n">offset</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">VERTEX</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">)</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is how it looks like with the same value, where <code>y_offset</code> equals to <code>1.5</code> and <code>radius</code> equals to <code>100.0</code>:</p>
<p><img src="/posts/spherical-gerstner-waves/1-3-no-distortion.png" alt="No distortion projection"></p>
<p>As you can see, the distortion is no longer there. We can keep the <code>y_exponent</code> value to <code>4.0</code> as we have right now, but you can tweak that around. The paper mentions that setting the <code>y_exponent</code> value to <code>2.0</code> also works pretty good, but overall <code>4.0</code> looks the best.</p>
<p>Technically, we are done with the projection. But, while we&rsquo;re at it, lets add a new uniform called <code>basis</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">y_offset</span> <span class="o">=</span> <span class="mf">100.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">radius</span> <span class="o">=</span> <span class="mf">1000.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="n">mat3</span> <span class="n">basis</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><p>And apply the <code>basis</code> to the projection calculation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">vec3</span> <span class="n">init_vertex</span> <span class="o">=</span> <span class="n">VERTEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_vertex</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">y_exponent</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">.</span><span class="n">z</span><span class="p">),</span> <span class="n">y_exponent</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">vec3</span> <span class="n">rotated_vertex</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">*</span> <span class="n">init_vertex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">vec3</span> <span class="n">rotated_offset</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">*</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">vec3</span> <span class="n">grid</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">rotated_offset</span> <span class="o">+</span> <span class="n">rotated_vertex</span><span class="p">)</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">VERTEX</span> <span class="o">=</span> <span class="n">grid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><p>Now, we can use update this <code>basis</code> uniform when we want to rotate the plane. For example, this is the result when I change the basis to <code>(0.0, 1.0, 0.0), (-1.0, 0.0, 0.0), (0.0, 0.0, 1.0)</code>, which essentially making the plane to face right instead of up:</p>
<p><img src="/posts/spherical-gerstner-waves/1-4-rotated.png" alt="No distortion projection"></p>
<p>By playing around with the <code>y_offset</code> and updating the <code>basis</code> accordingly, we can create the effect of having the planet covered in water when we look at it from the space by setting the <code>y_offset</code> to something close to <code>0.0</code>, whereas when we get closer to the planet surface, we can increase the value to something like <code>1.5</code> so that the ocean plane would shrink, only to cover the necessary area around the camera.</p>
<p>Cool! Now let&rsquo;s continue to the Gerstner wave calculation.</p>
<hr>
<h2 id="gerstner-wave-calculation">Gerstner Wave Calculation<a href="#gerstner-wave-calculation" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Firstly, we need to set up all the necessary variables for the Gerstner function first. Let&rsquo;s add a few uniform variables and those variables in the vertex shader:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">position_os</span> <span class="o">=</span> <span class="n">grid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">position_os_norm</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">position_os</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">sin_part</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">cos_part</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">sin_part_normal</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">cos_part_normal</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">tangent</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now, let&rsquo;s start setting up the <code>spherical_gerstner_wave</code> function just above the <code>vertex</code> function by defining the variables first:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">spherical_gerstner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">wave_data</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">wave_dir</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">pos_os_norm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">inout</span> <span class="k">float</span> <span class="n">sin_part</span><span class="p">,</span> <span class="k">inout</span> <span class="k">vec3</span> <span class="n">cos_part</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">inout</span> <span class="k">float</span> <span class="n">sin_part_normal</span><span class="p">,</span> <span class="k">inout</span> <span class="k">vec3</span> <span class="n">cos_part_normal</span><span class="p">,</span> <span class="k">inout</span> <span class="k">vec3</span> <span class="n">tangent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">amp_scale</span><span class="p">,</span> <span class="k">float</span> <span class="n">s_e0</span><span class="p">,</span> <span class="k">float</span> <span class="n">s_e1</span><span class="p">,</span> <span class="k">float</span> <span class="n">freq_scale</span><span class="p">,</span> <span class="k">float</span> <span class="n">t</span><span class="p">,</span> <span class="k">float</span> <span class="n">r</span><span class="p">,</span> <span class="k">float</span> <span class="n">time</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Heh, I&rsquo;m sure there are better ways to set this up, but I put lots of variables in this function so that I can move this function to a separate include file later. But anyways, let&rsquo;s breakdown the variables here:</p>
<ol>
<li><code>vec4 wave_data</code> contains four <code>float</code> values, which represents the amplitude, steepness, frequency, and wave speed;</li>
<li><code>vec3 wave_dir</code> describes the wave direction (or more precisely where does this wave starts from);</li>
<li><code>vec3 pos_os_norm</code> describes the normalized vertex position;</li>
<li><code>inout float sin_part</code> and <code>inout vec3 cos_part</code> will be the input and output of the sum of sine part and the cosine part of the Gerstner wave calculation for the vertex respectively;</li>
<li>Similarly, <code>inout float sin_part_normal</code> and <code>inout vec3 cos_part_normal</code> will be the input and output of the sum of sine part and the cosine part of the Gerstner wave calculation for the normal vector respectively;</li>
<li><code>inout vec3 tangent</code> will be the input and output for the tangent vector of the vertex (which we don&rsquo;t really need in the shader calculation, but let&rsquo;s just keep it here for now); and,</li>
<li>The rest of the variables are the values passed from our uniform variables.</li>
</ol>
<p>Before we continue, here&rsquo;s a snippet of the Gerstner calculation for both the vertex and the normal, which we&rsquo;ll be translating into the shader:</p>

<img src="2-1-p-equation.png"  class="center"  style="width: 60%;"    />



<img src="2-2-normal-equation.png"  class="center"  style="width: 60%;"    />


<p>Here you can see that both the sine and cosine components of the vertex and normal calculations are expressed as sums over all <code>N</code> waves. For now, we’ll start with just two waves (meaning <code>N</code> is 2), but later we can generalize this using a loop that iterates over a texture.</p>
<p>Let&rsquo;s setup the uniform variables for the waves:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">group_uniforms</span> <span class="n">WaveSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">wave_normal_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">amplitude_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">frequency_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">time_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">steepness_e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">steepness_e1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Optional for now, but we can feed this uniform with data from the</span>
</span></span><span class="line"><span class="cl"><span class="c1">// CPU if we want to synchronize our game objects with the shader.</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Wave 1</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec4</span> <span class="n">wave_1</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">wave_dir_1</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Wave 2</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec4</span> <span class="n">wave_2</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">wave_dir_2</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><p>I think most of the variables are self-explanatory, except for two:</p>
<ol>
<li><code>wave_normal_amount</code> can be used to as a weight to lerp/mix the normal between directly upwards or completely facing the normal; and,</li>
<li><code>steepness_e0</code> and <code>steepness_e1</code> are used to avoid the waves from generating loops due to extreme values.</li>
</ol>
<p>Cool! Let&rsquo;s update the vertex shader:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="n">spherical_gerstner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">wave_1</span><span class="p">,</span> <span class="n">wave_dir_1</span><span class="p">,</span> <span class="n">position_os_norm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">sin_part</span><span class="p">,</span> <span class="n">cos_part</span><span class="p">,</span> <span class="n">sin_part_normal</span><span class="p">,</span> <span class="n">cos_part_normal</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">amplitude_scale</span><span class="p">,</span> <span class="n">steepness_e0</span><span class="p">,</span> <span class="n">steepness_e1</span><span class="p">,</span> <span class="n">frequency_scale</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">radius</span><span class="p">,</span> <span class="n">TIME</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">spherical_gerstner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">wave_2</span><span class="p">,</span> <span class="n">wave_dir_2</span><span class="p">,</span> <span class="n">position_os_norm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">sin_part</span><span class="p">,</span> <span class="n">cos_part</span><span class="p">,</span> <span class="n">sin_part_normal</span><span class="p">,</span> <span class="n">cos_part_normal</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">amplitude_scale</span><span class="p">,</span> <span class="n">steepness_e0</span><span class="p">,</span> <span class="n">steepness_e1</span><span class="p">,</span> <span class="n">frequency_scale</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">radius</span><span class="p">,</span> <span class="n">TIME</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We are now calling the <code>spherical_gerstner</code> function but apparently it won&rsquo;t do a thing since we haven&rsquo;t implemented the calculation just yet. So let&rsquo;s get back to it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// I&#39;m skipping the parameters because it&#39;s too long, but don&#39;t omit those</span>
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">spherical_gerstner</span><span class="p">(...)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_dir_norm</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">wave_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">amplitude</span> <span class="o">=</span> <span class="n">amp_scale</span> <span class="o">*</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">steepness</span> <span class="o">=</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">abs</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">pos_os_norm</span><span class="p">,</span> <span class="n">wave_dir_norm</span><span class="p">)),</span> <span class="n">s_e0</span><span class="p">,</span> <span class="n">s_e1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">freq_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">fi</span> <span class="o">=</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">di</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">pos_os_norm</span><span class="p">,</span> <span class="n">cross</span><span class="p">(</span><span class="n">pos_os_norm</span> <span class="o">-</span> <span class="n">wave_dir_norm</span><span class="p">,</span> <span class="n">pos_os_norm</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">li</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">pos_os_norm</span><span class="p">,</span> <span class="n">wave_dir_norm</span><span class="p">))</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sin_part</span> <span class="o">+=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_part</span> <span class="o">+=</span> <span class="n">steepness</span> <span class="o">*</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">)</span> <span class="o">*</span> <span class="n">di</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sin_part_normal</span> <span class="o">+=</span> <span class="n">steepness</span> <span class="o">*</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">frequency</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_part_normal</span> <span class="o">+=</span> <span class="n">di</span> <span class="o">*</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">frequency</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">di_cross</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">pos_os_norm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">tangent</span> <span class="o">+=</span> <span class="n">di_cross</span> <span class="o">/</span> <span class="n">length</span><span class="p">(</span><span class="n">di_cross</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Phew! That is the core of our shader. It is a direct implementation of the equation I provided above, for both the vertex and the normal. Let&rsquo;s break it down a bit:</p>
<ol>
<li>We firstly calculate the amplitude, steepness, frequency, and wave speed (<code>fi</code>) of the wave. The steepness also includes a calculation I mentioned before to prevent the waves from forming a loop by using the <code>smoothstep</code> function.</li>
<li>We need to calculate the direction vector along which the wave travels (<code>di</code>) and the distance from the wave direction to the vertex position (<code>li</code>). These values are necessary for calculating the sine and cosine parts.</li>
<li>We calculate the sine and cosine parts, applying it to our <code>inout</code> variables, for both the vertex and the normal calculations.</li>
<li>Lastly, we calculate the tangent vector.</li>
</ol>
<p>Let&rsquo;s update the vertex shader:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="n">tangent</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">tangent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">surface_level</span> <span class="o">=</span> <span class="n">position_os_norm</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_movement</span> <span class="o">=</span> <span class="n">position_os_norm</span> <span class="o">*</span> <span class="n">sin_part</span> <span class="o">+</span> <span class="n">cos_part</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_pos</span> <span class="o">=</span> <span class="n">surface_level</span> <span class="o">+</span> <span class="n">wave_movement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_normal</span> <span class="o">=</span> <span class="n">position_os_norm</span> <span class="o">-</span> <span class="n">position_os_norm</span> <span class="o">*</span> <span class="n">sin_part_normal</span> <span class="o">-</span> <span class="n">cos_part_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">wave_normal</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">position_os_norm</span><span class="p">,</span> <span class="n">wave_normal</span><span class="p">,</span> <span class="n">wave_normal_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">wave_normal</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">wave_normal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">VERTEX</span> <span class="o">=</span> <span class="n">wave_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">NORMAL</span> <span class="o">=</span> <span class="n">wave_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now let&rsquo;s setup the uniform with some basic values to see the initial result (feel free to tweak this around):</p>
<p><img src="/posts/spherical-gerstner-waves/2-3-material-setup.png" alt="Material setup"></p>
<p>Also update the wave uniforms if it&rsquo;s still showing zeros:</p>

<img src="2-4-wave-material-setup.png"  class="center"  style="width: 40%;"    />


<p>Aaand you should have a result now!</p>
<video controls preload="auto" width="100%"  playsinline class="html-video">
    <source src="/posts/spherical-gerstner-waves/result-1.mp4" type="video/mp4">
  <span>Your browser doesn't support embedded videos, but don't worry, you can <a href="/posts/spherical-gerstner-waves/result-1.mp4">download it</a> and watch it with your favorite video player!</span>
</video>
<p>You can see the waves being a bit distorted when we increase the frequency scale. This is due to the low resolution of the plane, so take that into account when you play around with the frequency scale and the amplitude scale.</p>
<p>Here is the final vertex shader:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">group_uniforms</span> <span class="n">GridSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">y_offset</span> <span class="o">=</span> <span class="mf">100.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">y_exponent</span> <span class="o">=</span> <span class="mf">4.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">radius</span> <span class="o">=</span> <span class="mf">1003.4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="n">mat3</span> <span class="n">basis</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">group_uniforms</span> <span class="n">WaveSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">wave_normal_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">amplitude_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">frequency_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">time_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">steepness_e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">steepness_e1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Wave 1</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec4</span> <span class="n">wave_1</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">wave_dir_1</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Wave 2</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec4</span> <span class="n">wave_2</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">wave_dir_2</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">spherical_gerstner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">wave_data</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">wave_dir</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">pos_os_norm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">inout</span> <span class="k">float</span> <span class="n">sin_part</span><span class="p">,</span> <span class="k">inout</span> <span class="k">vec3</span> <span class="n">cos_part</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">inout</span> <span class="k">float</span> <span class="n">sin_part_normal</span><span class="p">,</span> <span class="k">inout</span> <span class="k">vec3</span> <span class="n">cos_part_normal</span><span class="p">,</span> <span class="k">inout</span> <span class="k">vec3</span> <span class="n">tangent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">amp_scale</span><span class="p">,</span> <span class="k">float</span> <span class="n">s_e0</span><span class="p">,</span> <span class="k">float</span> <span class="n">s_e1</span><span class="p">,</span> <span class="k">float</span> <span class="n">freq_scale</span><span class="p">,</span> <span class="k">float</span> <span class="n">t</span><span class="p">,</span> <span class="k">float</span> <span class="n">r</span><span class="p">,</span> <span class="k">float</span> <span class="n">time</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_dir_norm</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">wave_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">amplitude</span> <span class="o">=</span> <span class="n">amp_scale</span> <span class="o">*</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">steepness</span> <span class="o">=</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">abs</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">pos_os_norm</span><span class="p">,</span> <span class="n">wave_dir_norm</span><span class="p">)),</span> <span class="n">s_e0</span><span class="p">,</span> <span class="n">s_e1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">freq_scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// fi == wave speed</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">fi</span> <span class="o">=</span> <span class="n">wave_data</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// di == direction along which the wave travels</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">di</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">pos_os_norm</span><span class="p">,</span> <span class="n">cross</span><span class="p">(</span><span class="n">pos_os_norm</span> <span class="o">-</span> <span class="n">wave_dir_norm</span><span class="p">,</span> <span class="n">pos_os_norm</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// li == length to vertex and to wave direction</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">li</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">pos_os_norm</span><span class="p">,</span> <span class="n">wave_dir_norm</span><span class="p">))</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sin_part</span> <span class="o">+=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_part</span> <span class="o">+=</span> <span class="n">steepness</span> <span class="o">*</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">)</span> <span class="o">*</span> <span class="n">di</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sin_part_normal</span> <span class="o">+=</span> <span class="n">steepness</span> <span class="o">*</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">frequency</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">cos_part_normal</span> <span class="o">+=</span> <span class="n">di</span> <span class="o">*</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">frequency</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">li</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">di_cross</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">pos_os_norm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">tangent</span> <span class="o">+=</span> <span class="n">di_cross</span> <span class="o">/</span> <span class="n">length</span><span class="p">(</span><span class="n">di_cross</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">init_vertex</span> <span class="o">=</span> <span class="n">VERTEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">init_vertex</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">y_exponent</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">init_vertex</span><span class="p">.</span><span class="n">z</span><span class="p">),</span> <span class="n">y_exponent</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">rotated_vertex</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">*</span> <span class="n">init_vertex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">rotated_offset</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">*</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">grid</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">rotated_offset</span> <span class="o">+</span> <span class="n">rotated_vertex</span><span class="p">)</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">position_os</span> <span class="o">=</span> <span class="n">grid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">position_os_norm</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">position_os</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">sin_part</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">cos_part</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">sin_part_normal</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">cos_part_normal</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">tangent</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">spherical_gerstner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">wave_1</span><span class="p">,</span> <span class="n">wave_dir_1</span><span class="p">,</span> <span class="n">position_os_norm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">sin_part</span><span class="p">,</span> <span class="n">cos_part</span><span class="p">,</span> <span class="n">sin_part_normal</span><span class="p">,</span> <span class="n">cos_part_normal</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">amplitude_scale</span><span class="p">,</span> <span class="n">steepness_e0</span><span class="p">,</span> <span class="n">steepness_e1</span><span class="p">,</span> <span class="n">frequency_scale</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">radius</span><span class="p">,</span> <span class="n">TIME</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">spherical_gerstner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">wave_2</span><span class="p">,</span> <span class="n">wave_dir_2</span><span class="p">,</span> <span class="n">position_os_norm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">sin_part</span><span class="p">,</span> <span class="n">cos_part</span><span class="p">,</span> <span class="n">sin_part_normal</span><span class="p">,</span> <span class="n">cos_part_normal</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">amplitude_scale</span><span class="p">,</span> <span class="n">steepness_e0</span><span class="p">,</span> <span class="n">steepness_e1</span><span class="p">,</span> <span class="n">frequency_scale</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">radius</span><span class="p">,</span> <span class="n">TIME</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">tangent</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">tangent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">surface_level</span> <span class="o">=</span> <span class="n">position_os_norm</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_movement</span> <span class="o">=</span> <span class="n">position_os_norm</span> <span class="o">*</span> <span class="n">sin_part</span> <span class="o">+</span> <span class="n">cos_part</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_pos</span> <span class="o">=</span> <span class="n">surface_level</span> <span class="o">+</span> <span class="n">wave_movement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">wave_normal</span> <span class="o">=</span> <span class="n">position_os_norm</span> <span class="o">-</span> <span class="n">position_os_norm</span> <span class="o">*</span> <span class="n">sin_part_normal</span> <span class="o">-</span> <span class="n">cos_part_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">wave_normal</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">position_os_norm</span><span class="p">,</span> <span class="n">wave_normal</span><span class="p">,</span> <span class="n">wave_normal_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">wave_normal</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">wave_normal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">VERTEX</span> <span class="o">=</span> <span class="n">wave_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">NORMAL</span> <span class="o">=</span> <span class="n">wave_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We can make things easier for us by replacing the <code>wave_data</code> and <code>wave_data_dir</code> variables with a texture instead. That way, we can generate wave data and direction from a GDScript node and then feed it to a texture for the shader to read.</p>
<hr>
<h2 id="wave-data-and-direction-using-texture">Wave Data and Direction using Texture<a href="#wave-data-and-direction-using-texture" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="texture-generator-setup">Texture Generator Setup<a href="#texture-generator-setup" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>The idea is to have the all the wave information being stored into a single texture. So to do that, let&rsquo;s setup a folder called <code>gerstner_waves</code> and a new GDScript class called <code>gerstner_waves_generator.gd</code>, which will be a short one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript" data-lang="gdscript"><span class="line"><span class="cl"><span class="nd">@tool</span>
</span></span><span class="line"><span class="cl"><span class="kd">class_name</span> <span class="nc">GersnterWaveGenerator</span> <span class="kd">extends</span> <span class="nc">Node</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@export</span><span class="n">_tool_button</span><span class="p">(</span><span class="s2">&#34;Generate&#34;</span><span class="p">,</span> <span class="s2">&#34;Callable&#34;</span><span class="p">)</span> <span class="kd">var</span> <span class="n">generate_action</span><span class="p">:</span> <span class="nc">Callable</span> <span class="o">=</span> <span class="n">_generate_wave_texture</span>
</span></span><span class="line"><span class="cl"><span class="nd">@export</span> <span class="kd">var</span> <span class="n">num_of_waves</span><span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl"><span class="nd">@export</span> <span class="kd">var</span> <span class="n">filename</span><span class="p">:</span> <span class="nc">String</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">_generate_wave_texture</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">void</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="n">img</span><span class="p">:</span> <span class="nc">Image</span> <span class="o">=</span> <span class="nc">Image</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_of_waves</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nc">Image</span><span class="o">.</span><span class="n">FORMAT_RGBAF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">randomize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span><span class="p">:</span> <span class="kt">int</span> <span class="ow">in</span> <span class="n">num_of_waves</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="n">data</span><span class="p">:</span> <span class="nc">Color</span> <span class="o">=</span> <span class="nc">Color</span><span class="p">(</span><span class="nb">randf</span><span class="p">(),</span> <span class="nb">randf</span><span class="p">(),</span> <span class="nb">randf</span><span class="p">(),</span> <span class="nb">randf</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="n">direction</span><span class="p">:</span> <span class="nc">Color</span> <span class="o">=</span> <span class="nc">Color</span><span class="p">(</span><span class="nb">randf</span><span class="p">(),</span> <span class="nb">randf</span><span class="p">(),</span> <span class="nb">randf</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">img</span><span class="o">.</span><span class="nf">set_pixel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">img</span><span class="o">.</span><span class="nf">set_pixel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">img</span><span class="o">.</span><span class="nf">save_png</span><span class="p">(</span><span class="s2">&#34;res://gerstner_waves/</span><span class="si">%s</span><span class="s2">.png&#34;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Gerstner data texture generated! (res://gerstner_waves/</span><span class="si">%s</span><span class="s2">.png)&#34;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
</span></span></code></pre></div><p>What this script does is basically just creating an image file where each row represents the wave. The first column represents the wave data (a variable with type vector 4, if you remember), and the second column represents the wave direction (vector 3).</p>
<p>Add the script onto the scene and you can see some setup in the inspector window:</p>
<p><img src="/posts/spherical-gerstner-waves/3-1-gerstner-wave-generator.png" alt="Gerstner waves setup"></p>
<p>Determine how many waves you want to have in your shader, and also include the filename (without the extension). When you click generate, a confirmation will be shown in the output console, and the texture will be saved in the <code>gerstner_waves</code> folder that we created before.</p>
<p>If you can&rsquo;t see it in the Godot filesystem, you probably need to open the folder using your files explorer first (I&rsquo;m not sure why, Godot doesn&rsquo;t seem to immediately recognize the file.) You should now see the texture:</p>
<p><img src="/posts/spherical-gerstner-waves/3-2-gerstner-texture.png" alt="Gerstner waves setup"></p>
<p>And we also need to make sure that the texture is not compressed. Double click on the texture, and then head to the import window and make sure that the compress mode is set to be lossless, and then click on re-import:</p>
<p><img src="/posts/spherical-gerstner-waves/3-3-reimport.png" alt="Gerstner waves setup"></p>
<p>Now the texture is ready to be fed into the material, but we need to setup the shader first. So let&rsquo;s do that next!</p>
<h3 id="shader-updates">Shader Updates<a href="#shader-updates" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>We also need to update the shader file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// We can remove these lines:</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Wave 1</span>
</span></span><span class="line"><span class="cl"><span class="c1">// uniform vec4 wave_1 = vec4(1.0);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// uniform vec3 wave_dir_1 = vec3(0., 1., 0.);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Wave 2</span>
</span></span><span class="line"><span class="cl"><span class="c1">// uniform vec4 wave_2 = vec4(1.0);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// uniform vec3 wave_dir_2 = vec3(0., 1., 0.);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// And replace it with this one:</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">wave_tex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// Also replace these two function calls:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// spherical_gerstner(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	wave_1, wave_dir_1, position_os_norm,</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	sin_part, cos_part, sin_part_normal, cos_part_normal, tangent,</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	amplitude_scale, steepness_e0, steepness_e1, frequency_scale, time_scale,</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	radius, TIME</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// );</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// spherical_gerstner(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	wave_2, wave_dir_2, position_os_norm,</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	sin_part, cos_part, sin_part_normal, cos_part_normal, tangent,</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	amplitude_scale, steepness_e0, steepness_e1, frequency_scale, time_scale,</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//	radius, TIME</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// );</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// With this one instead:</span>
</span></span><span class="line"><span class="cl">	<span class="k">int</span> <span class="n">wave_data_amount</span> <span class="o">=</span> <span class="n">textureSize</span><span class="p">(</span><span class="n">wave_tex</span><span class="p">,</span> <span class="mo">0</span><span class="p">).</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wave_data_amount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec4</span> <span class="n">data</span> <span class="o">=</span> <span class="n">texelFetch</span><span class="p">(</span><span class="n">wave_tex</span><span class="p">,</span> <span class="k">ivec2</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="mo">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">texelFetch</span><span class="p">(</span><span class="n">wave_tex</span><span class="p">,</span> <span class="k">ivec2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="mo">0</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">spherical_gerstner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="n">data</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">position_os_norm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">sin_part</span><span class="p">,</span> <span class="n">cos_part</span><span class="p">,</span> <span class="n">sin_part_normal</span><span class="p">,</span> <span class="n">cos_part_normal</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">amplitude_scale</span><span class="p">,</span> <span class="n">steepness_e0</span><span class="p">,</span> <span class="n">steepness_e1</span><span class="p">,</span> <span class="n">frequency_scale</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">radius</span><span class="p">,</span> <span class="n">TIME</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In the new vertex function, we loop through every row of the texture, fetching the first <code>y</code> index (first column) to get the wave data, and also fetching the second <code>y</code> index (second column) to get the wave direction. Once we fetched them, we feed it into the <code>spherical_gerstner</code> function again.</p>
<p>Now we&rsquo;re ready to feed the texture into the material. You just need to drag and drop the texture into the <code>wave_tex</code> slot in the material:</p>
<p><img src="/posts/spherical-gerstner-waves/3-4-inserting-texture.png" alt="Gerstner waves setup"></p>
<p>And now you should be able to see the end result!</p>
<video controls preload="auto" width="100%"  playsinline class="html-video">
    <source src="/posts/spherical-gerstner-waves/result-2.mp4" type="video/mp4">
  <span>Your browser doesn't support embedded videos, but don't worry, you can <a href="/posts/spherical-gerstner-waves/result-2.mp4">download it</a> and watch it with your favorite video player!</span>
</video>
<h2 id="uh-my-ocean-is-white">Uh&hellip; My Ocean is White?<a href="#uh-my-ocean-is-white" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Yeah I know, I know, we haven&rsquo;t touched the fragment shader yet! I don&rsquo;t want to cover the fragment shader that much right now because it&rsquo;s not that important for now (<em>honest reason</em>: I haven&rsquo;t figured out how the UV would work) but basically I just replaced the <code>ALBEDO</code> variable with a uniform value:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">group_uniforms</span> <span class="n">VisualSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec4</span> <span class="n">main_color</span> <span class="o">:</span> <span class="n">source_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">main_color</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now you can change the <code>main_color</code> value and your plane will no longer be white colored anymore!</p>
<h2 id="yay-conclusion-whats-next">Yay! Conclusion! What&rsquo;s Next?<a href="#yay-conclusion-whats-next" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Cool! Now we have a plane that is simulating the ocean waves using the Gerstner waves formula, that is wrapping around a sphere and is distortion-free.</p>
<p>There are lots of things that still needs to be done, including utilizing the basis to rotate the plane and adjusting the y_offset value, syncing with the game objects, and also properly coloring the ocean plane, when that becomes important (<em>read</em>: when I solve UV calculation.) But they will come in due time!</p>
<p>For now, enjoy the wiggly plane! Hope it&rsquo;s been useful!</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Catlike Coding: Waves. (<a href="https://catlikecoding.com/unity/tutorials/flow/waves/">https://catlikecoding.com/unity/tutorials/flow/waves/</a>)&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Florian Michelic and Michael Kenzel. Real-Time Rendering of Procuderally Generated Planets. TU Graz, 2018. (<a href="https://cescg.org/cescg_submission/real-time-rendering-of-procedurally-generated-planets/">https://cescg.org/cescg_submission/real-time-rendering-of-procedurally-generated-planets/</a>)&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>kulesz. Planetary Water. (<a href="https://github.com/kulesz/PlanetaryWater/">https://github.com/kulesz/PlanetaryWater/</a>)&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

      </div></div>

  
    

  

  
    
  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
